<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>Auto Test VIP Payment Method</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e1e2e 0%, #2d2d44 100%);
            color: #e0e0e0;
            padding: 40px;
            margin: 0;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.05);
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #6366f1;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #94a3b8;
            margin-bottom: 30px;
        }

        button {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px 5px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .log {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
            line-height: 1.6;
        }

        .success {
            color: #10b981;
        }

        .error {
            color: #ef4444;
        }

        .info {
            color: #3b82f6;
        }

        .warning {
            color: #f59e0b;
        }

        .step {
            margin: 8px 0;
            padding: 8px;
            background: rgba(255, 255, 255, 0.02);
            border-left: 3px solid #6366f1;
            padding-left: 12px;
        }

        .result-table {
            margin-top: 20px;
            width: 100%;
            border-collapse: collapse;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            overflow: hidden;
        }

        .result-table th {
            background: rgba(99, 102, 241, 0.2);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid rgba(99, 102, 241, 0.3);
        }

        .result-table td {
            padding: 10px 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üß™ Auto Test: VIP Payment Method</h1>
        <p class="subtitle">T·ª± ƒë·ªông test Payment Method column trong VIP History</p>

        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 10px; color: #94a3b8;">
                üìÅ Ch·ªçn file backup (DB/backup-11-12-2025.json):
            </label>
            <input type="file" id="backupFile" accept=".json" style="
            background: rgba(255,255,255,0.1);
            color: white;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid rgba(99,102,241,0.3);
            width: 100%;
            cursor: pointer;
          ">
        </div>

        <div>
            <button onclick="runFullTest()">‚ñ∂Ô∏è Ch·∫°y Test T·ª± ƒê·ªông</button>
            <button onclick="clearLog()">üóëÔ∏è Clear Log</button>
            <button onclick="clearLocalStorage()">üí• Clear localStorage</button>
        </div>

        <div id="log" class="log"></div>
        <div id="results"></div>
    </div>

    <script>
        let logEl;

        function log(msg, type = 'info') {
            if (!logEl) logEl = document.getElementById('log');
            const colors = {
                success: '#10b981',
                error: '#ef4444',
                info: '#3b82f6',
                warning: '#f59e0b'
            };
            const icon = {
                success: '‚úÖ',
                error: '‚ùå',
                info: '‚ÑπÔ∏è',
                warning: '‚ö†Ô∏è'
            };
            const div = document.createElement('div');
            div.className = 'step';
            div.innerHTML = `<span style="color: ${colors[type]}">${icon[type]} ${msg}</span>`;
            logEl.appendChild(div);
            logEl.scrollTop = logEl.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            document.getElementById('results').innerHTML = '';
        }

        function clearLocalStorage() {
            localStorage.clear();
            log('ƒê√£ x√≥a to√†n b·ªô localStorage', 'success');
        }

        async function loadBackupData() {
            log('ƒêang load backup data...', 'info');

            const fileInput = document.getElementById('backupFile');
            if (!fileInput.files || !fileInput.files[0]) {
                log('‚ùå Vui l√≤ng ch·ªçn file backup tr∆∞·ªõc!', 'error');
                return null;
            }

            try {
                const file = fileInput.files[0];
                const text = await file.text();
                const backup = JSON.parse(text);

                // Restore data
                if (backup.data) {
                    localStorage.setItem('orderHistory', JSON.stringify(backup.data.orderHistory || []));
                    localStorage.setItem('vipList', backup.data.vipList || '');
                    localStorage.setItem('vipTransactions', JSON.stringify(backup.data.vipTransactions || []));
                    log('‚úÖ ƒê√£ restore data t·ª´ backup: ' + file.name, 'success');
                    return backup.data;
                }
            } catch (err) {
                log('‚ùå L·ªói load backup: ' + err.message, 'error');
                return null;
            }
        }

        function parseVipList(text) {
            const map = new Map();
            text.split('\n').forEach(line => {
                const match = line.match(/^(.+?)=(\d+)/);
                if (match) {
                    map.set(match[1].trim(), parseInt(match[2]));
                }
            });
            return map;
        }

        function addVipTopup(name, amount) {
            const vipTx = JSON.parse(localStorage.getItem('vipTransactions') || '[]');
            vipTx.unshift({
                id: Date.now(),
                ts: new Date().toISOString(),
                name: name,
                amount: amount,
                type: 'topup'
            });
            localStorage.setItem('vipTransactions', JSON.stringify(vipTx));

            // Update VIP list
            const vipList = localStorage.getItem('vipList') || '';
            const vipMap = parseVipList(vipList);
            vipMap.set(name, (vipMap.get(name) || 0) + amount);
            const newList = Array.from(vipMap.entries()).map(([n, b]) => `${n}=${b}ƒë`).join('\n');
            localStorage.setItem('vipList', newList);

            log(`üí∞ N·∫°p VIP: ${name} +${amount}ƒë`, 'success');
        }

        function payDebtWithVip(name, orderId, itemName, amount) {
            const vipTx = JSON.parse(localStorage.getItem('vipTransactions') || '[]');
            vipTx.unshift({
                id: Date.now(),
                ts: new Date().toISOString(),
                name: name,
                amount: -amount,
                type: 'order',
                itemName: itemName,
                orderId: orderId,
                paid: true
            });
            localStorage.setItem('vipTransactions', JSON.stringify(vipTx));

            // Update VIP list
            const vipList = localStorage.getItem('vipList') || '';
            const vipMap = parseVipList(vipList);
            vipMap.set(name, (vipMap.get(name) || 0) - amount);
            const newList = Array.from(vipMap.entries()).map(([n, b]) => `${n}=${b}ƒë`).join('\n');
            localStorage.setItem('vipList', newList);

            // Mark order as paid
            const orders = JSON.parse(localStorage.getItem('orderHistory') || '[]');
            const order = orders.find(o => o.id === orderId);
            if (order) {
                order.details.forEach(d => {
                    if (d.name === name) d.paid = true;
                });
                localStorage.setItem('orderHistory', JSON.stringify(orders));
            }

            log(`üçú Tr·∫£ VIP: ${name} -${amount}ƒë cho "${itemName}"`, 'success');
        }

        function verifyVipHistory(name) {
            log('üîç ƒêang ki·ªÉm tra VIP History...', 'info');

            const vipTx = JSON.parse(localStorage.getItem('vipTransactions') || '[]');
            const orders = JSON.parse(localStorage.getItem('orderHistory') || '[]');

            // Get transactions for this person
            const personTx = vipTx.filter(tx => tx.name === name);

            // Get order transactions from order history
            const orderTxs = [];
            orders.forEach(order => {
                order.details?.forEach(detail => {
                    if (detail.name === name && detail.due) {
                        orderTxs.push({
                            orderId: order.id,
                            itemName: order.itemName,
                            amount: detail.due,
                            paid: detail.paid
                        });
                    }
                });
            });

            log(`üìä T√¨m th·∫•y ${personTx.length} VIP transactions v√† ${orderTxs.length} order transactions`, 'info');

            // Check results
            const results = [];

            // Check VIP topup
            const topup = personTx.find(tx => tx.type === 'topup');
            results.push({
                type: 'N·∫°p VIP',
                expected: '300ƒë',
                actual: topup ? `${topup.amount}ƒë` : 'Kh√¥ng t√¨m th·∫•y',
                pass: topup && topup.amount === 300
            });

            // Check VIP order payment
            const vipOrder = personTx.find(tx => tx.type === 'order');
            results.push({
                type: 'VIP Order Payment',
                expected: 'C√≥ itemName + orderId + paid=true',
                actual: vipOrder ? `itemName="${vipOrder.itemName}", orderId=${vipOrder.orderId}, paid=${vipOrder.paid}` : 'Kh√¥ng t√¨m th·∫•y',
                pass: vipOrder && vipOrder.itemName && vipOrder.orderId && vipOrder.paid
            });

            // Display results
            let html = '<h3 style="color: #6366f1; margin-top: 30px;">üìã K·∫øt Qu·∫£ Test</h3>';
            html += '<table class="result-table"><thead><tr><th>Test Case</th><th>K·ª≥ v·ªçng</th><th>Th·ª±c t·∫ø</th><th>K·∫øt qu·∫£</th></tr></thead><tbody>';

            results.forEach(r => {
                const status = r.pass ? '<span class="success">‚úÖ PASS</span>' : '<span class="error">‚ùå FAIL</span>';
                html += `<tr><td>${r.type}</td><td>${r.expected}</td><td>${r.actual}</td><td>${status}</td></tr>`;
            });

            html += '</tbody></table>';
            document.getElementById('results').innerHTML = html;

            const allPass = results.every(r => r.pass);
            log(allPass ? 'üéâ T·∫§T C·∫¢ TEST ƒê·ªÄU PASS!' : '‚ö†Ô∏è C√ì TEST FAIL', allPass ? 'success' : 'warning');

            return allPass;
        }

        async function runFullTest() {
            clearLog();
            log('üöÄ B·∫Øt ƒë·∫ßu Auto Test...', 'info');

            // Step 1: Clear localStorage
            clearLocalStorage();
            await new Promise(r => setTimeout(r, 500));

            // Step 2: Load backup
            const data = await loadBackupData();
            if (!data) {
                log('‚ùå Test th·∫•t b·∫°i: Kh√¥ng load ƒë∆∞·ª£c backup', 'error');
                return;
            }
            await new Promise(r => setTimeout(r, 500));

            // Step 3: Find Ryan's unpaid Ch·∫£ l·ª•a order
            const orders = data.orderHistory || [];
            let ryanOrder = null;
            for (const order of orders) {
                const detail = order.details?.find(d => d.name === 'Ryan' && !d.paid && order.itemName.includes('Ch·∫£ l·ª•a'));
                if (detail) {
                    ryanOrder = { order, detail };
                    break;
                }
            }

            if (!ryanOrder) {
                log('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y ƒë∆°n Ch·∫£ l·ª•a ch∆∞a tr·∫£ c·ªßa Ryan', 'warning');
                return;
            }

            log(`üì¶ T√¨m th·∫•y ƒë∆°n: ${ryanOrder.order.itemName} - ${ryanOrder.detail.due}ƒë`, 'info');
            await new Promise(r => setTimeout(r, 500));

            // Step 4: Check if Ryan already has VIP balance
            const vipList = data.vipList || '';
            const vipMap = parseVipList(vipList);
            const currentBalance = vipMap.get('Ryan') || 0;

            if (currentBalance === 0) {
                // Ryan ch∆∞a c√≥ VIP ‚Üí N·∫°p VIP
                addVipTopup('Ryan', 300);
                await new Promise(r => setTimeout(r, 500));
            } else {
                log(`üí∞ Ryan ƒë√£ c√≥ VIP balance: ${currentBalance}ƒë (skip topup)`, 'info');
            }

            // Step 5: Pay with VIP
            payDebtWithVip('Ryan', ryanOrder.order.id, ryanOrder.order.itemName, ryanOrder.detail.due);
            await new Promise(r => setTimeout(r, 500));

            // Step 6: Verify
            verifyVipHistory('Ryan');

            log('‚ú® Test ho√†n t·∫•t! B·∫°n c√≥ th·ªÉ m·ªü order_helper_v3_advanced.html ƒë·ªÉ xem k·∫øt qu·∫£', 'success');
        }
    </script>
</body>

</html>