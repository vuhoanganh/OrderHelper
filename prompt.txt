PROMPT 2.2 ‚Äî VIP Report ‚ÄúS·ªï ph·ª•‚Äù ph·∫£i ƒë·ªçc FULL DB (orders + vip tx), show to√†n b·ªô giao d·ªãch 1 ng∆∞·ªùi, ch·∫°y s·ªë d∆∞ chu·∫©n

PH·∫†M VI
- Ch·ªâ s·ª≠a file: order_helper_v3_advanced.html
- Kh√¥ng ƒë·ªïi nghi·ªáp v·ª• ngo√†i ph·∫ßn B√°o c√°o VIP ‚Äì S·ªï ph·ª•
- Kh√¥ng thay ƒë·ªïi theme/CSS t·ªïng th·ªÉ (ch·ªâ th√™m c·ªôt/badge n·∫øu b·∫Øt bu·ªôc)

M·ª§C TI√äU (CH·ªêT)
Khi ch·ªçn 1 VIP Member trong dropdown, tab ‚Äúüìã B√°o c√°o VIP - S·ªï ph·ª•‚Äù ph·∫£i:
1) HI·ªÇN TH·ªä FULL TIMELINE t·∫•t c·∫£ giao d·ªãch c·ªßa ng∆∞·ªùi ƒë√≥ t·ª´ DB:
   - Orders t·ª´ orderHistory.details: hi·ªÉn th·ªã c·∫£ Cash & VIP
   - VIP ledger tx t·ª´ vipTransactions: topup/cashout/opening/adjustment (n·∫øu c√≥)
   - vipTransactions.type="order" ch·ªâ d√πng ƒë·ªÉ audit/link; kh√¥ng double-count
   - Orphan vipTransactions order (thi·∫øu orderId/detailIndex/refId) ph·∫£i v·∫´n hi·ªÉn th·ªã nh∆∞ng g·∫Øn nh√£n ORPHAN

2) CH·∫†Y ‚ÄúS·ªê D∆Ø‚Äù ƒê√öNG theo logic t·∫°p ho√°:
   ending = opening + Œ£(deltaVip)
   Trong ƒë√≥:
   - Order VIP: deltaVip = -due
   - Order Cash: deltaVip = 0 (v·∫´n show s·ªë ti·ªÅn m√≥n ƒë·ªÉ minh b·∫°ch)
   - Topup: deltaVip = +amount
   - Cashout: deltaVip = -amount
   - Opening/Adjustment: deltaVip = amount
   - ORPHAN (unlinked vipTx order): m·∫∑c ƒë·ªãnh deltaVip = 0 (KH√îNG t·ª± ƒë·ªông tr·ª´/c·ªông v√†o s·ªë d∆∞), ch·ªâ hi·ªÉn th·ªã ƒë·ªÉ ƒë·ªëi so√°t

3) ENDING BALANCE ph·∫£i KH·ªöP s·ªë d∆∞ hi·ªán t·∫°i trong ‚ÄúQu·∫£n l√Ω VIP (vipList)‚Äù theo DB hi·ªán t·∫°i.
   - Sau khi t√≠nh xong, computedEnding c·ªßa report ph·∫£i b·∫±ng vipListBalance (Name=xxxƒë).
   - N·∫øu kh√¥ng kh·ªõp: hi·ªán warning ‚ÄúMISMATCH diff=...‚Äù, v√† hi·ªÉn th·ªã danh s√°ch ORPHAN + c√°c d√≤ng VIP order/topup/cashout ƒë·ªÉ ng∆∞·ªùi v·∫≠n h√†nh ki·ªÉm tra.

Y√äU C·∫¶U K·ª∏ THU·∫¨T (B·∫ÆT BU·ªòC)
A) T·∫°o builder th·ªëng nh·∫•t:
   function buildVipStatementFromDB(memberName, options) -> { rows, summary, meta }
   - options: { from?:Date, to?:Date, includeCashOrders?:true, includeOrphans?:true }

B) ƒê·ªçc t·ª´ 2 ngu·ªìn DB:
1) orderHistory:
   - Duy·ªát m·ªçi order + detailIndex.
   - N·∫øu details[i].name === memberName => t·∫°o 1 row type="order"
   - L·∫•y:
     + ts = order.date || new Date(Number(order.id)) || new Date(order.id)
     + itemName = (detail.itemName || order.itemName || "")
     + due = Number(detail.due)
     + paid = !!detail.paid
     + pm = detail.paymentMethod || (detail.isVipPayment ? "vip" : "cash") || "cash"
   - Set:
     + paymentType = (pm === "vip" && paid) ? "VIP" : "Cash"
     + displayAmount = -due (lu√¥n show s·ªë ti·ªÅn m√≥n)
     + deltaVip = (paymentType==="VIP") ? -due : 0
     + ref = `${order.id}-${i}`

2) vipTransactions:
   - L·∫•y c√°c tx c·ªßa memberName.
   - V·ªõi tx.type in ["topup","cashout","opening","adjust","adjustment"]:
     + t·∫°o row t∆∞∆°ng ·ª©ng, deltaVip = tx.amount
   - V·ªõi tx.type==="order":
     + N·∫øu c√≥ ƒë·ªß orderId & detailIndex (ho·∫∑c refId) => KH√îNG ƒë∆∞a v√†o rows t√≠nh to√°n (tr√°nh double-count v√¨ orderHistory ƒë√£ t·∫°o row order).
     + N·∫øu thi·∫øu link => t·∫°o row ORPHAN:
       - type="orphan"
       - displayAmount = tx.amount
       - deltaVip = 0 (m·∫∑c ƒë·ªãnh kh√¥ng ·∫£nh h∆∞·ªüng s·ªë d∆∞)
       - note="ORPHAN: missing orderId/detailIndex/refId"
       - meta.orphans.push(tx)

C) Sort & running balance:
   - X√¢y rows full-history r·ªìi sort theo ts tƒÉng d·∫ßn (opening c√≥ th·ªÉ pin l√™n ƒë·∫ßu n·∫øu mu·ªën).
   - running = openingAmount (sum tx.type="opening" + adjustments n·∫øu t√≠nh v√†o opening)
   - For each row: running += row.deltaVip; set row.balanceAfter = running

D) Summary:
   - opening = sum(opening rows deltaVip)
   - totalTopup = sum(deltaVip where type="topup")
   - totalCashout = sum(abs(deltaVip) where type="cashout") (ho·∫∑c gi·ªØ d·∫•u √¢m tu·ª≥ UI)
   - totalVipSpend = sum(abs(deltaVip) where row is order VIP)  (cash orders kh√¥ng t√≠nh)
   - ending = last row.balanceAfter (ho·∫∑c opening n·∫øu kh√¥ng c√≥ row)

E) Render UI tab ‚ÄúB√°o c√°o VIP - S·ªï ph·ª•‚Äù:
   - B·∫£ng ph·∫£i c√≥ √≠t nh·∫•t: Ng√†y gi·ªù | Lo·∫°i | N·ªôi dung | PT | S·ªë ti·ªÅn (displayAmount) | Delta VIP (deltaVip) | S·ªë d∆∞ (balanceAfter) | Ref
   - N·∫øu UI kh√¥ng mu·ªën th√™m c·ªôt ‚ÄúDelta VIP‚Äù, th√¨ c·ªôt +/- ph·∫£i l√† deltaVip; c√≤n s·ªë ti·ªÅn m√≥n ƒë∆∞a v√†o ‚ÄúN·ªôi dung‚Äù (vd: ‚Äúƒê∆°n: Ph·ªü b√≤ (Cash -38ƒë)‚Äù)

F) CSV export:
   - Xu·∫•t ƒë√∫ng rows ƒëang hi·ªÉn th·ªã, c·ªôt t·ªëi thi·ªÉu:
     tsISO, tsLocal, name, rowType, paymentType, description, displayAmount, deltaVip, balanceAfter, ref, orderId, detailIndex, txId, note

AUTO TEST (B·∫ÆT BU·ªòC)
T·∫°o:
window.selfTest_vipReportFromDB = function() {
  - parse vipList => expected balances map
  - for each member:
      statement = buildVipStatementFromDB(member)
      diff = statement.summary.ending - expected[member]
      console.table([{member, expected, ending, diff, orphanCount}])
  - N·∫øu c√≥ diff != 0: console.warn + in ra 10 rows cu·ªëi c·ªßa statement ƒë·ªÉ debug
}

DOD (DONE DEFINITION)
- V·ªõi m·ªçi member trong vipList: endingBalance c·ªßa report == vipListBalance
- Report hi·ªÉn th·ªã ƒë·ªß order cash/vip + topup/cashout/opening/adjustment
- Orphan v·∫´n hi·ªÉn th·ªã nh∆∞ng kh√¥ng ·∫£nh h∆∞·ªüng balance (deltaVip=0) v√† c√≥ warning
- CSV export ƒë√∫ng d·ªØ li·ªáu ƒëang xem
- selfTest_vipReportFromDB ch·∫°y ra diff=0 cho to√†n b·ªô member (ho·∫∑c log r√µ member n√†o c√≤n mismatch v√† orphanCount)
